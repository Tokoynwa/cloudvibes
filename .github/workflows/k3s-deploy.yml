name: ðŸš€ K3s CloudVibes Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        default: 'deploy'
        type: choice
        options: [deploy, status, restart]

env:
  IMAGE_NAME: cloudvibes
  NAMESPACE: default

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“¦ Install & Build
      run: |
        npm ci --prefer-offline --no-audit
        npm run build
        
    - name: ðŸ³ Build & Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          set -e
          
          # Generate image tag
          IMAGE_TAG="$(date +%Y%m%d-%H%M%S)-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "ðŸš€ Deploying CloudVibes:$IMAGE_TAG"
          
          # Navigate to project directory
          cd /my-mcp-server/cloudvibes
          
          # Pull latest code
          git fetch origin
          git reset --hard origin/main
          
          # Build Docker image
          echo "ðŸ³ Building Docker image..."
          docker build -t cloudvibes:$IMAGE_TAG .
          
          # Import to k3s
          echo "ðŸ“¥ Importing to k3s..."
          docker save cloudvibes:$IMAGE_TAG | sudo k3s ctr images import -
          
          # Deploy to k3s
          echo "ðŸš€ Deploying to k3s..."
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl set image deployment/cloudvibes cloudvibes=cloudvibes:$IMAGE_TAG -n default
          
          # Wait for rollout
          echo "â³ Waiting for rollout..."
          kubectl rollout status deployment/cloudvibes -n default --timeout=300s
          
          # Health check
          echo "ðŸ¥ Health check..."
          sleep 10
          if curl -f -s https://cloudvibes.org/api/health > /dev/null; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Health check failed"
            exit 1
          fi
        
    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ CloudVibes Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** $([ $? -eq 0 ] && echo 'âœ… SUCCESS' || echo 'âŒ FAILED')" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed to:** https://cloudvibes.org" >> $GITHUB_STEP_SUMMARY
        echo "**Server:** 216.87.32.17" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Access Application:" >> $GITHUB_STEP_SUMMARY
        echo "- **Website:** https://cloudvibes.org" >> $GITHUB_STEP_SUMMARY
        echo "- **Health Check:** https://cloudvibes.org/api/health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Features Deployed:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Weather Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… About & Contact Pages" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Weather Guides" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Help & FAQ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… SSL Certificate (Let's Encrypt)" >> $GITHUB_STEP_SUMMARY